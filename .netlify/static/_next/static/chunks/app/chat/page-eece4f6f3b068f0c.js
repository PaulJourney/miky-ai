(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[8457],{630:(e,r,t)=>{Promise.resolve().then(t.bind(t,2047))},1760:e=>{function r(e){var r=Error("Cannot find module '"+e+"'");throw r.code="MODULE_NOT_FOUND",r}r.keys=()=>[],r.resolve=r,r.id=1760,e.exports=r},2047:(e,r,t)=>{"use strict";t.r(r),t.d(r,{default:()=>i});var a=t(5853),n=t(2115),s=t(5695),l=t(4105);function i(){let e=(0,s.useRouter)(),{user:r,loading:t}=(0,l.A)();return(0,n.useEffect)(()=>{if(t)return;if(r)return void e.replace("/dashboard");let a=(()=>{let e=localStorage.getItem("preferred-locale");if(e&&["it","es","en"].includes(e))return e;let r=navigator.language.split("-")[0];return["it","es"].includes(r)?r:"en"})();"en"===a?e.replace("/en/chat"):e.replace("/".concat(a,"/chat"))},[e,r,t]),(0,a.Y)("div",{className:"min-h-screen bg-gray-950 text-white flex items-center justify-center",children:(0,a.FD)("div",{className:"text-center",children:[(0,a.Y)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"}),(0,a.Y)("p",{className:"text-gray-400",children:"Redirecting..."})]})})}},2099:(e,r,t)=>{"use strict";t.d(r,{Bh:()=>c,Hh:()=>s,Jv:()=>l,ND:()=>a,Rk:()=>u,f3:()=>o,xw:()=>i});let a=(0,t(2354).UU)("https://adwjbkjmehkypaetkejw.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFkd2pia2ptZWhreXBhZXRrZWp3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ3Mjg0ODcsImV4cCI6MjA3MDMwNDQ4N30.R4XUc6-VNQcXWdioXKJ87x4dQyeguOFFP87KDiixk2g");function n(e){let r=Date.now().toString(36),t=e.split("@")[0].slice(0,4).toUpperCase(),a=Math.random().toString(36).substring(2,6).toUpperCase();return"".concat(t).concat(a).concat(r.slice(-3)).substring(0,10)}async function s(e,r,t,s){try{let{data:l,error:i}=await a.auth.signUp({email:e.toLowerCase(),password:r,options:{data:{full_name:t,referred_by:s||null}}});if(i)return{error:{message:i.message}};if(l.user){let{error:r}=await a.from("profiles").upsert({id:l.user.id,email:e.toLowerCase(),full_name:t,referral_code:n(e),referred_by:s||null,credits:100,water_cleaned_liters:0,subscription_plan:"free",subscription_status:"active",referral_level:1,total_referral_earnings:0,pending_payout:0,language:"en",is_admin:!1,is_mock:!1},{onConflict:"id"});r&&console.error("Profile creation error:",r)}return{data:l,error:null}}catch(e){return{error:{message:e.message||"An unexpected error occurred"}}}}async function l(e,r){try{let{data:t,error:n}=await a.auth.signInWithPassword({email:e.toLowerCase(),password:r});if(n){if(n.message.includes("Invalid login credentials"))return{error:{message:"Incorrect email or password. Please check your credentials and try again."}};if(n.message.includes("Email not confirmed"))return{error:{message:"Please check your email and click the verification link before signing in."}};return{error:{message:n.message}}}return{data:t,error:null}}catch(e){return{error:{message:e.message||"An unexpected error occurred"}}}}async function i(e){try{let{error:r}=await a.auth.resetPasswordForEmail(e,{redirectTo:"".concat("Miky.ai","/auth/reset-password")});if(r)return{error:{message:r.message}};return{error:null}}catch(e){return{error:{message:e.message||"An unexpected error occurred"}}}}async function o(e){try{let{error:r}=await a.auth.updateUser({password:e});if(r)return{error:{message:r.message}};return{error:null}}catch(e){return{error:{message:e.message||"An unexpected error occurred"}}}}async function u(){try{let{data:{user:o}}=await a.auth.getUser();if(!o)return{data:null,error:null};let{data:u,error:c}=await a.from("profiles").select("*").eq("id",o.id).single();if(c){if("PGRST116"===c.code){var e,r,t,s,l,i;console.log("Profile not found, creating new profile for user:",o.id);let{error:u}=await a.from("profiles").insert({id:o.id,email:(null==(e=o.email)?void 0:e.toLowerCase())||"",full_name:(null==(r=o.user_metadata)?void 0:r.full_name)||(null==(t=o.email)?void 0:t.split("@")[0])||"User",referral_code:n(o.email||""),credits:100,water_cleaned_liters:0,subscription_plan:"free",subscription_status:"active",referral_level:1,total_referral_earnings:0,pending_payout:0,language:"en",is_admin:!1,is_mock:!1});if(u){if(console.error("Error creating profile:",u),"42501"===u.code)return console.log("RLS policy blocking profile creation, returning default profile"),{data:{id:o.id,email:(null==(s=o.email)?void 0:s.toLowerCase())||"",full_name:(null==(l=o.user_metadata)?void 0:l.full_name)||(null==(i=o.email)?void 0:i.split("@")[0])||"User",avatar_url:null,referral_code:n(o.email||""),referred_by:null,credits:100,water_cleaned_liters:0,subscription_plan:"free",subscription_status:"active",stripe_customer_id:null,referral_level:1,total_referral_earnings:0,pending_payout:0,language:"en",is_admin:!1,is_mock:!0,created_at:new Date().toISOString(),updated_at:new Date().toISOString()},error:null};return{data:null,error:{message:u.message}}}let{data:c,error:d}=await a.from("profiles").select("*").eq("id",o.id).single();if(d)return{data:null,error:{message:d.message}};return{data:c,error:null}}return{data:null,error:{message:c.message}}}return{data:u,error:null}}catch(e){return{data:null,error:{message:e.message||"An unexpected error occurred"}}}}function c(e){return a.auth.onAuthStateChange(e)}},4105:(e,r,t)=>{"use strict";t.d(r,{A:()=>o,O:()=>i});var a=t(5853),n=t(2115),s=t(2099);let l=(0,n.createContext)({user:null,profile:null,session:null,loading:!0,signOut:async()=>{},refreshProfile:async()=>{}});function i(e){let{children:r}=e,[t,i]=(0,n.useState)(null),[o,u]=(0,n.useState)(null),[c,d]=(0,n.useState)(null),[f,m]=(0,n.useState)(!0),g=async()=>{if(!t)return void u(null);try{let{data:e,error:r}=await (0,s.Rk)();r?(console.error("Error fetching profile:",r),u(null)):u(e)}catch(e){console.error("Error refreshing profile:",e),u(null)}},p=async()=>{try{await s.ND.auth.signOut(),i(null),u(null),d(null)}catch(e){console.error("Error signing out:",e)}};return(0,n.useEffect)(()=>{s.ND.auth.getSession().then(e=>{var r;let{data:{session:t},error:a}=e;a&&console.error("Error getting session:",a),d(t),i(null!=(r=null==t?void 0:t.user)?r:null),m(!1)});let{data:{subscription:e}}=(0,s.Bh)(async(e,r)=>{var t,a;console.log("Auth state changed:",e,null==r||null==(t=r.user)?void 0:t.id),d(r),i(null!=(a=null==r?void 0:r.user)?a:null),m(!1),"SIGNED_IN"===e&&(null==r?void 0:r.user)&&await g(),"SIGNED_OUT"===e&&u(null)});return()=>e.unsubscribe()},[]),(0,n.useEffect)(()=>{!t||o||f||g()},[t,o,f]),(0,a.Y)(l.Provider,{value:{user:t,profile:o,session:c,loading:f,signOut:p,refreshProfile:g},children:r})}function o(){let e=(0,n.useContext)(l);if(!e)throw Error("useAuth must be used within an AuthProvider");return e}},5695:(e,r,t)=>{"use strict";var a=t(8999);t.o(a,"usePathname")&&t.d(r,{usePathname:function(){return a.usePathname}}),t.o(a,"useRouter")&&t.d(r,{useRouter:function(){return a.useRouter}}),t.o(a,"useSearchParams")&&t.d(r,{useSearchParams:function(){return a.useSearchParams}})}},e=>{var r=r=>e(e.s=r);e.O(0,[5853,2354,8441,1684,7358],()=>r(630)),_N_E=e.O()}]);